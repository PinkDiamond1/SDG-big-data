<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 8 Location labeling and parameter optimization | GPS Analytics</title>
  <meta name="description" content="Guided step by step analysis of income based mobility patterns from GPS data." />
  <meta name="generator" content="bookdown 0.23 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 8 Location labeling and parameter optimization | GPS Analytics" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Guided step by step analysis of income based mobility patterns from GPS data." />
  <meta name="github-repo" content="rstudio/bookdown-demo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 8 Location labeling and parameter optimization | GPS Analytics" />
  
  <meta name="twitter:description" content="Guided step by step analysis of income based mobility patterns from GPS data." />
  

<meta name="author" content="Chapter 8 Location labeling and parameter optimization | GPS Analytics Group" />


<meta name="date" content="2021-08-29" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="migration.html"/>
<link rel="next" href="windex.html"/>
<script src="libs/header-attrs-2.10/header-attrs.js"></script>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">GPS Mobility Analysis</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="data.html"><a href="data.html"><i class="fa fa-check"></i><b>2</b> Data</a>
<ul>
<li class="chapter" data-level="2.1" data-path="data.html"><a href="data.html#gps-data"><i class="fa fa-check"></i><b>2.1</b> GPS Data</a></li>
<li class="chapter" data-level="2.2" data-path="data.html"><a href="data.html#wealth-index-data"><i class="fa fa-check"></i><b>2.2</b> Wealth Index Data</a></li>
<li class="chapter" data-level="2.3" data-path="data.html"><a href="data.html#administrative-boundaries-data"><i class="fa fa-check"></i><b>2.3</b> Administrative Boundaries Data</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="geocode.html"><a href="geocode.html"><i class="fa fa-check"></i><b>3</b> Geocode</a>
<ul>
<li class="chapter" data-level="3.1" data-path="geocode.html"><a href="geocode.html#efficient-spatial-joining-and-geospatial-indexing"><i class="fa fa-check"></i><b>3.1</b> Efficient spatial joining and Geospatial Indexing</a></li>
<li class="chapter" data-level="3.2" data-path="geocode.html"><a href="geocode.html#code"><i class="fa fa-check"></i><b>3.2</b> Code</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="geocode.html"><a href="geocode.html#loading-administrative-units"><i class="fa fa-check"></i><b>3.2.1</b> Loading administrative units</a></li>
<li class="chapter" data-level="3.2.2" data-path="geocode.html"><a href="geocode.html#loading-ping-data-and-h3-indexing"><i class="fa fa-check"></i><b>3.2.2</b> Loading ping data and h3 indexing</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="geocode.html"><a href="geocode.html#initial-coarse-geo-spatial-join-with-shapefiles"><i class="fa fa-check"></i><b>3.3</b> Initial coarse geo-spatial join with shapefiles</a></li>
<li class="chapter" data-level="3.4" data-path="geocode.html"><a href="geocode.html#final-exact-join-with-a-subset-of-the-shapefiles"><i class="fa fa-check"></i><b>3.4</b> Final exact join with a subset of the shapefiles</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="stops.html"><a href="stops.html"><i class="fa fa-check"></i><b>4</b> Finding Stops</a>
<ul>
<li class="chapter" data-level="4.1" data-path="stops.html"><a href="stops.html#definition"><i class="fa fa-check"></i><b>4.1</b> Definition</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="stops.html"><a href="stops.html#get-stop-locations"><i class="fa fa-check"></i><b>4.1.1</b> Get stop locations</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="stops.html"><a href="stops.html#clustering-recurrent-stops"><i class="fa fa-check"></i><b>4.2</b> Clustering recurrent stops</a></li>
<li class="chapter" data-level="4.3" data-path="stops.html"><a href="stops.html#appending-pings-from-recent-dates"><i class="fa fa-check"></i><b>4.3</b> Appending pings from recent dates</a></li>
<li class="chapter" data-level="4.4" data-path="stops.html"><a href="stops.html#stops-geocoding"><i class="fa fa-check"></i><b>4.4</b> Stops geocoding</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="labeling.html"><a href="labeling.html"><i class="fa fa-check"></i><b>5</b> Defining Home and Work Locations</a>
<ul>
<li class="chapter" data-level="5.1" data-path="labeling.html"><a href="labeling.html#seasonal-patterns"><i class="fa fa-check"></i><b>5.1</b> Seasonal patterns</a></li>
<li class="chapter" data-level="5.2" data-path="labeling.html"><a href="labeling.html#code-1"><i class="fa fa-check"></i><b>5.2</b> Code</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="mobility.html"><a href="mobility.html"><i class="fa fa-check"></i><b>6</b> Mobility Patterns</a>
<ul>
<li class="chapter" data-level="6.1" data-path="mobility.html"><a href="mobility.html#socio-economic-groups"><i class="fa fa-check"></i><b>6.1</b> Socio-economic groups</a></li>
<li class="chapter" data-level="6.2" data-path="mobility.html"><a href="mobility.html#selection"><i class="fa fa-check"></i><b>6.2</b> Individual’s selection</a></li>
<li class="chapter" data-level="6.3" data-path="mobility.html"><a href="mobility.html#measures"><i class="fa fa-check"></i><b>6.3</b> Measures</a>
<ul>
<li class="chapter" data-level="6.3.1" data-path="mobility.html"><a href="mobility.html#measuring-mobility-patterns"><i class="fa fa-check"></i><b>6.3.1</b> Measuring mobility patterns</a></li>
<li class="chapter" data-level="6.3.2" data-path="mobility.html"><a href="mobility.html#measuring-change"><i class="fa fa-check"></i><b>6.3.2</b> Measuring change</a></li>
<li class="chapter" data-level="6.3.3" data-path="mobility.html"><a href="mobility.html#home-isolated-commuters-and-low-wealth-commuters"><i class="fa fa-check"></i><b>6.3.3</b> Home-isolated, commuters and low-wealth commuters</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="migration.html"><a href="migration.html"><i class="fa fa-check"></i><b>7</b> Migration Patterns</a>
<ul>
<li class="chapter" data-level="7.1" data-path="migration.html"><a href="migration.html#description"><i class="fa fa-check"></i><b>7.1</b> Description</a></li>
<li class="chapter" data-level="7.2" data-path="migration.html"><a href="migration.html#user-selection"><i class="fa fa-check"></i><b>7.2</b> User selection</a></li>
<li class="chapter" data-level="7.3" data-path="migration.html"><a href="migration.html#code-2"><i class="fa fa-check"></i><b>7.3</b> Code</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="optimization.html"><a href="optimization.html"><i class="fa fa-check"></i><b>8</b> Location labeling and parameter optimization</a>
<ul>
<li class="chapter" data-level="8.1" data-path="optimization.html"><a href="optimization.html#ground-truth"><i class="fa fa-check"></i><b>8.1</b> Ground truth</a>
<ul>
<li class="chapter" data-level="8.1.1" data-path="optimization.html"><a href="optimization.html#construction"><i class="fa fa-check"></i><b>8.1.1</b> Construction</a></li>
<li class="chapter" data-level="8.1.2" data-path="optimization.html"><a href="optimization.html#validation"><i class="fa fa-check"></i><b>8.1.2</b> Validation</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="optimization.html"><a href="optimization.html#parameter-optimization"><i class="fa fa-check"></i><b>8.2</b> Parameter optimization</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="optimization.html"><a href="optimization.html#performance-indicators"><i class="fa fa-check"></i><b>8.2.1</b> Performance indicators</a></li>
<li class="chapter" data-level="8.2.2" data-path="optimization.html"><a href="optimization.html#performance-error-estimates-and-bootstrapping"><i class="fa fa-check"></i><b>8.2.2</b> Performance error estimates and bootstrapping</a></li>
<li class="chapter" data-level="8.2.3" data-path="optimization.html"><a href="optimization.html#parallel-bootstrapping-and-optimization-result-storage"><i class="fa fa-check"></i><b>8.2.3</b> Parallel bootstrapping and optimization result storage</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="optimization.html"><a href="optimization.html#parameter-configuration-selection"><i class="fa fa-check"></i><b>8.3</b> Parameter configuration selection</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="windex.html"><a href="windex.html"><i class="fa fa-check"></i><b>9</b> Wealth Index</a>
<ul>
<li class="chapter" data-level="9.1" data-path="windex.html"><a href="windex.html#variables-to-estimate-the-social-gap-index-in-mexico"><i class="fa fa-check"></i><b>9.1</b> Variables to estimate the Social Gap Index in Mexico</a></li>
<li class="chapter" data-level="9.2" data-path="windex.html"><a href="windex.html#education"><i class="fa fa-check"></i><b>9.2</b> Education</a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="windex.html"><a href="windex.html#health-services-access"><i class="fa fa-check"></i><b>9.2.1</b> Health Services Access</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="windex.html"><a href="windex.html#household-characteristics"><i class="fa fa-check"></i><b>9.3</b> Household Characteristics</a></li>
<li class="chapter" data-level="9.4" data-path="windex.html"><a href="windex.html#assets-ownership"><i class="fa fa-check"></i><b>9.4</b> Assets Ownership</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="voronoi.html"><a href="voronoi.html"><i class="fa fa-check"></i><b>10</b> Voronoi</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">GPS Analytics</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="optimization" class="section level1" number="8">
<h1><span class="header-section-number">Chapter 8</span> Location labeling and parameter optimization</h1>
<p>One of the crucial steps allowing us to perform the analyses presented in this book is the ability to infer individual home locations and workplaces.
Additional information, based on the individual pattern of visits to recurrent locations, are added to each stop location to distinguish their roles and importance.</p>
<p>This process has been extensively presented in Chapter <a href="labeling.html#labeling">5</a>. Here, we discuss how we converged on a specific parameter configuration to be shared by all the different countries analysed in the book.</p>
<div id="ground-truth" class="section level2" number="8.1">
<h2><span class="header-section-number">8.1</span> Ground truth</h2>
<div id="construction" class="section level3" number="8.1.1">
<h3><span class="header-section-number">8.1.1</span> Construction</h3>
<p>The first element needed to optimize the process is a ground truth to which each labeling output can be compared with. To this extent, we selected a sample of 100 active individuals for each country. Active individuals were randomly selected from six activity-based buckets: High, medium, and low activity during the pre-pandemic period; high, medium, and low activity after the pre-pandemic period (buckets combined the combination of the different class, e.g. high-medium or low-low activity buckets). Activity classification was performed splitting in percentile groups with similar size.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb22-1"><a href="optimization.html#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add bucket creation code here</span></span></code></pre></div>
<p>The uniform selection of individuals acroos different activity buckets provided a balanced set of data ensuring algorithmic stability across a differentiated spectra of mobile phone usage. We stress that, even if activity groups were constructed using groups of individuals their stop locations were not aggregated in the same group, but each individual locations were separately and independently subjected to the same validation procedure.</p>
</div>
<div id="validation" class="section level3" number="8.1.2">
<h3><span class="header-section-number">8.1.2</span> Validation</h3>
<p>After the sampling step, individuals’ stop locations are submitted to a validator whose task is to label locations into three different categories: home location, work location, and others. Validators were allowed to label multiple home locations per individual as well as multiple work locations. Validators were required to use all the information at their disposal (both the maps and the distribution of time spent at locations over time-of-the-day, day-of-the-week, and the day-of-the-year). The stop location of same individuals were submitted to two independent validators simultaneously. The results from the first round of manual labeling were, then, submitted to a third validator responsible of solving conflicts between the first two validators. For each step all the validators were provided with the same information presented in the same way through the dashboard presented in figure.</p>
<div class="figure" style="text-align: center">
<img src="gps-mobility_files/figure-html/groudtruth_dashboard-fig-1.png" alt="Screenshot of the dashboard used by the validators to manually assign labels to locations. Validators have two maps sourced from different providers (OpenStreetMap at the top, and GoogleMaps at the bottom) to explore. Both maps provide different point of interest information in support to the decisionmaking. The bottom map also allows the validator to switch to a satellate imagery mode. On the right side of the dashboard, validators are provided with summary information for all the locations visited by the individual. In particular, the average distribution of time-at-location during the daytime is provided at the top. Similarly, the middle panel provide interactive distribution for the weekly patters (distribution of time spent on a given weekday at a specific location), while the bottom right panel provide panel data spanning over the entire 2020 period. Data presented in this figure are synthetic in compliance to the individual privacy preserving guidelines from the data provider." width="80%" />
<p class="caption">
(#fig:groudtruth_dashboard-fig)Screenshot of the dashboard used by the validators to manually assign labels to locations. Validators have two maps sourced from different providers (OpenStreetMap at the top, and GoogleMaps at the bottom) to explore. Both maps provide different point of interest information in support to the decisionmaking. The bottom map also allows the validator to switch to a satellate imagery mode. On the right side of the dashboard, validators are provided with summary information for all the locations visited by the individual. In particular, the average distribution of time-at-location during the daytime is provided at the top. Similarly, the middle panel provide interactive distribution for the weekly patters (distribution of time spent on a given weekday at a specific location), while the bottom right panel provide panel data spanning over the entire 2020 period. Data presented in this figure are synthetic in compliance to the individual privacy preserving guidelines from the data provider.
</p>
</div>
</div>
</div>
<div id="parameter-optimization" class="section level2" number="8.2">
<h2><span class="header-section-number">8.2</span> Parameter optimization</h2>
<p>The result of the validation procedure are stored as .csv files for each country containing the label by the first independent validator in the “FirstOpinion” column, the label of the second independent validator in the “SecondOpinion” column, and the final label assigned by the conflict-breaker validator in the “FinalOpinion” column. The final labels were compared with the results of the labeling running the labeling step of the pipeline described in <a href="labeling.html#labeling">5</a> joining the two over the individual unique identifier.</p>
<p>The labeling results produced by the algorithm were restructured using the following function, which returns a dataframe of containing the individual id, stop location unique (for each individual) identifier, and the label returned by the algorithm.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb23-1"><a href="optimization.html#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_algorithm_labels(<span class="op">**</span>args):</span>
<span id="cb23-2"><a href="optimization.html#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb23-3"><a href="optimization.html#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="co">  To load computed labels the following are required:</span></span>
<span id="cb23-4"><a href="optimization.html#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co">      country:                      country of interest</span></span>
<span id="cb23-5"><a href="optimization.html#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="co">      home_period_window:           size of the window for home</span></span>
<span id="cb23-6"><a href="optimization.html#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="co">      work_period_window:           size of the window for work</span></span>
<span id="cb23-7"><a href="optimization.html#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="co">      min_periods_over_window:      minimum days/win_size on which candidate should appear to be labelled as H</span></span>
<span id="cb23-8"><a href="optimization.html#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="co">      min_periods_over_window_work: minimum days/win_size on which candidate should appear to be labelled as W</span></span>
<span id="cb23-9"><a href="optimization.html#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="co">      work_activity_average:        average time spent at work in a day over the window</span></span>
<span id="cb23-10"><a href="optimization.html#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="co">      time_fraction_work:           fraction of user time in records spent at work</span></span>
<span id="cb23-11"><a href="optimization.html#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="co">      fpath:                        path to the label results (country dependent)</span></span>
<span id="cb23-12"><a href="optimization.html#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="co">  OUTPUT: dataframe of user_id,cluster_label,AlgorithmOpinion</span></span>
<span id="cb23-13"><a href="optimization.html#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="co">  &quot;&quot;&quot;</span></span>
<span id="cb23-14"><a href="optimization.html#cb23-14" aria-hidden="true" tabindex="-1"></a>  country<span class="op">=</span>args[<span class="st">&quot;country&quot;</span>]</span>
<span id="cb23-15"><a href="optimization.html#cb23-15" aria-hidden="true" tabindex="-1"></a>  home_period_window<span class="op">=</span>args[<span class="st">&quot;home_period_window&quot;</span>]</span>
<span id="cb23-16"><a href="optimization.html#cb23-16" aria-hidden="true" tabindex="-1"></a>  work_period_window<span class="op">=</span>args[<span class="st">&quot;work_period_window&quot;</span>]</span>
<span id="cb23-17"><a href="optimization.html#cb23-17" aria-hidden="true" tabindex="-1"></a>  min_periods_over_window<span class="op">=</span>args[<span class="st">&quot;min_periods_over_window&quot;</span>]</span>
<span id="cb23-18"><a href="optimization.html#cb23-18" aria-hidden="true" tabindex="-1"></a>  min_periods_over_window_work<span class="op">=</span>args[<span class="st">&quot;min_periods_over_window_work&quot;</span>]</span>
<span id="cb23-19"><a href="optimization.html#cb23-19" aria-hidden="true" tabindex="-1"></a>  work_activity_average<span class="op">=</span>args[<span class="st">&quot;work_activity_average&quot;</span>]</span>
<span id="cb23-20"><a href="optimization.html#cb23-20" aria-hidden="true" tabindex="-1"></a>  time_fraction_work<span class="op">=</span>args[<span class="st">&quot;time_fraction_work&quot;</span>]</span>
<span id="cb23-21"><a href="optimization.html#cb23-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-22"><a href="optimization.html#cb23-22" aria-hidden="true" tabindex="-1"></a>  fname <span class="op">=</span> <span class="ss">f&#39;hpw</span><span class="sc">{</span>home_period_window<span class="sc">}</span><span class="ss">_wpw</span><span class="sc">{</span>work_period_window<span class="sc">}</span><span class="ss">_mpow</span><span class="sc">{</span>min_periods_over_window<span class="sc">}</span><span class="ss">_mpoww</span><span class="sc">{</span>min_periods_over_window_work<span class="sc">}</span><span class="ss">_waa</span><span class="sc">{</span>work_activity_average<span class="sc">}</span><span class="ss">_tfw</span><span class="sc">{</span>time_fraction_work<span class="sc">}</span><span class="ss">_v10.csv&#39;</span></span>
<span id="cb23-23"><a href="optimization.html#cb23-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-24"><a href="optimization.html#cb23-24" aria-hidden="true" tabindex="-1"></a>  df_hw <span class="op">=</span> pd.read_csv(os.path.join(fpath, fname),usecols<span class="op">=</span>[<span class="st">&quot;user_id&quot;</span>, <span class="st">&quot;location_type&quot;</span>, <span class="st">&quot;cluster_label&quot;</span>])</span>
<span id="cb23-25"><a href="optimization.html#cb23-25" aria-hidden="true" tabindex="-1"></a>  df_hw <span class="op">=</span> df_hw[df_hw.cluster_label.notna()]</span>
<span id="cb23-26"><a href="optimization.html#cb23-26" aria-hidden="true" tabindex="-1"></a>  df_hw[<span class="st">&#39;location_type&#39;</span>] <span class="op">=</span> df_hw.location_type.fillna(<span class="st">&#39;O&#39;</span>)</span>
<span id="cb23-27"><a href="optimization.html#cb23-27" aria-hidden="true" tabindex="-1"></a>  df_hw <span class="op">=</span> df_hw.drop_duplicates().reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-28"><a href="optimization.html#cb23-28" aria-hidden="true" tabindex="-1"></a>  df_hw <span class="op">=</span> df_hw[df_hw.location_type<span class="op">!=</span><span class="st">&#39;O&#39;</span>].rename(columns<span class="op">=</span>{<span class="st">&#39;location_type&#39;</span>:<span class="st">&#39;AlgorithmOpinion&#39;</span>})</span>
<span id="cb23-29"><a href="optimization.html#cb23-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> df_hw</span></code></pre></div>
<p>The arguments required by this functions are those over which the parameter optimization is performed. In particular, we performed a grid-search optimization for each different combination of the following parameter configurations:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="optimization.html#cb24-1" aria-hidden="true" tabindex="-1"></a>iter_params <span class="op">=</span> {</span>
<span id="cb24-2"><a href="optimization.html#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;home_period_window&quot;</span>:np.arange(<span class="dv">14</span>,<span class="dv">84</span>,<span class="dv">7</span>),</span>
<span id="cb24-3"><a href="optimization.html#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;work_period_window&quot;</span>:np.arange(<span class="dv">14</span>,<span class="dv">84</span>,<span class="dv">7</span>),</span>
<span id="cb24-4"><a href="optimization.html#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;min_periods_over_window&quot;</span>:np.around(np.linspace(<span class="fl">0.1</span>, <span class="fl">0.4</span>, <span class="dv">5</span>), decimals<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb24-5"><a href="optimization.html#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;min_periods_over_window_work&quot;</span>:np.around(np.linspace(<span class="fl">0.1</span>, <span class="fl">0.4</span>, <span class="dv">5</span>), decimals<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb24-6"><a href="optimization.html#cb24-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;work_activity_average&quot;</span>:[<span class="dv">1800</span><span class="op">*</span>hours <span class="cf">for</span> hours <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>,<span class="dv">5</span>)],</span>
<span id="cb24-7"><a href="optimization.html#cb24-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;time_fraction_work&quot;</span>:[<span class="fl">0.0</span>, <span class="fl">0.2</span>, <span class="fl">0.4</span>, <span class="fl">0.6</span>]</span>
<span id="cb24-8"><a href="optimization.html#cb24-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<div id="performance-indicators" class="section level3" number="8.2.1">
<h3><span class="header-section-number">8.2.1</span> Performance indicators</h3>
<p>In the code presented below we provide multiple performance indicators. Each one of those can be used to assess different aspects. For example, the intra-validators agreement can be compared with the average agreement between one of the two “first-step” validators and the algorithm (we do this using the Choen’s kappa statistic) to get a direct comparison between validators and algorithm accord. Focusing on direct performance metrics, we instead use the F1-score computed between the final validator’s opinion and the algorithm result looking for all locations correctly labelled as either “home-location” or “work-location.” The F1-score is computed for each one of the two labels independently and then aggregated averaging the two results.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb25-1"><a href="optimization.html#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># To speed up computations remove all locations labelled as &quot;O&quot; (other) from the data. </span></span>
<span id="cb25-2"><a href="optimization.html#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> filter_o(df,col1,col2): <span class="cf">return</span> df[(df[col1]<span class="op">!=</span><span class="st">&#39;O&#39;</span>)<span class="op">|</span>(df[col2]<span class="op">!=</span><span class="st">&#39;O&#39;</span>)]</span>
<span id="cb25-3"><a href="optimization.html#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="optimization.html#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_sample_metrics(df_sample,col_true,col_eval1):</span>
<span id="cb25-5"><a href="optimization.html#cb25-5" aria-hidden="true" tabindex="-1"></a>  a1 <span class="op">=</span> <span class="st">&#39;FirstOpinion&#39;</span></span>
<span id="cb25-6"><a href="optimization.html#cb25-6" aria-hidden="true" tabindex="-1"></a>  a2 <span class="op">=</span> <span class="st">&#39;SecondOpinion&#39;</span></span>
<span id="cb25-7"><a href="optimization.html#cb25-7" aria-hidden="true" tabindex="-1"></a>  dfte <span class="op">=</span> filter_o(df_sample,col_true,col_eval1)</span>
<span id="cb25-8"><a href="optimization.html#cb25-8" aria-hidden="true" tabindex="-1"></a>  df1e <span class="op">=</span> filter_o(df_sample,a1,col_eval1)</span>
<span id="cb25-9"><a href="optimization.html#cb25-9" aria-hidden="true" tabindex="-1"></a>  df2e <span class="op">=</span> filter_o(df_sample,a2,col_eval1)</span>
<span id="cb25-10"><a href="optimization.html#cb25-10" aria-hidden="true" tabindex="-1"></a>  df12 <span class="op">=</span> filter_o(df_sample,a1,a2)</span>
<span id="cb25-11"><a href="optimization.html#cb25-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-12"><a href="optimization.html#cb25-12" aria-hidden="true" tabindex="-1"></a>  kappa <span class="op">=</span> ((skm.cohen_kappa_score(df1e[a1],df1e[col_eval1], labels<span class="op">=</span>[<span class="st">&#39;H&#39;</span>,<span class="st">&#39;W&#39;</span>])<span class="op">+</span></span>
<span id="cb25-13"><a href="optimization.html#cb25-13" aria-hidden="true" tabindex="-1"></a>            skm.cohen_kappa_score(df2e[a2],df2e[col_eval1], labels<span class="op">=</span>[<span class="st">&#39;H&#39;</span>,<span class="st">&#39;W&#39;</span>]))<span class="op">/</span><span class="dv">2</span>)</span>
<span id="cb25-14"><a href="optimization.html#cb25-14" aria-hidden="true" tabindex="-1"></a>  accuracy <span class="op">=</span> skm.accuracy_score(dfte[col_true],dfte[col_eval1])</span>
<span id="cb25-15"><a href="optimization.html#cb25-15" aria-hidden="true" tabindex="-1"></a>  f1 <span class="op">=</span> skm.f1_score(dfte[col_true],dfte[col_eval1],labels<span class="op">=</span>[<span class="st">&#39;H&#39;</span>,<span class="st">&#39;W&#39;</span>],average<span class="op">=</span><span class="st">&#39;macro&#39;</span>)</span>
<span id="cb25-16"><a href="optimization.html#cb25-16" aria-hidden="true" tabindex="-1"></a>  f1H <span class="op">=</span> skm.f1_score(dfte[col_true],dfte[col_eval1],labels<span class="op">=</span>[<span class="st">&#39;H&#39;</span>],average<span class="op">=</span><span class="st">&#39;macro&#39;</span>)</span>
<span id="cb25-17"><a href="optimization.html#cb25-17" aria-hidden="true" tabindex="-1"></a>  f1W <span class="op">=</span> skm.f1_score(dfte[col_true],dfte[col_eval1],labels<span class="op">=</span>[<span class="st">&#39;W&#39;</span>],average<span class="op">=</span><span class="st">&#39;macro&#39;</span>)</span>
<span id="cb25-18"><a href="optimization.html#cb25-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-19"><a href="optimization.html#cb25-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># these are metrics computed one annotator against the other.</span></span>
<span id="cb25-20"><a href="optimization.html#cb25-20" aria-hidden="true" tabindex="-1"></a>  kappa_ann <span class="op">=</span> skm.cohen_kappa_score(df12[a1],df12[a2], labels<span class="op">=</span>[<span class="st">&#39;H&#39;</span>,<span class="st">&#39;W&#39;</span>])</span>
<span id="cb25-21"><a href="optimization.html#cb25-21" aria-hidden="true" tabindex="-1"></a>  accuracy_ann <span class="op">=</span> skm.accuracy_score(df12[a1],df12[a2])</span>
<span id="cb25-22"><a href="optimization.html#cb25-22" aria-hidden="true" tabindex="-1"></a>  f1_ann <span class="op">=</span> skm.f1_score(df12[a1],df12[a2],labels<span class="op">=</span>[<span class="st">&#39;H&#39;</span>,<span class="st">&#39;W&#39;</span>],average<span class="op">=</span><span class="st">&#39;macro&#39;</span>)</span>
<span id="cb25-23"><a href="optimization.html#cb25-23" aria-hidden="true" tabindex="-1"></a>  f1_annH <span class="op">=</span> skm.f1_score(df12[a1],df12[a2],labels<span class="op">=</span>[<span class="st">&#39;H&#39;</span>],average<span class="op">=</span><span class="st">&#39;macro&#39;</span>)</span>
<span id="cb25-24"><a href="optimization.html#cb25-24" aria-hidden="true" tabindex="-1"></a>  f1_annW <span class="op">=</span> skm.f1_score(df12[a1],df12[a2],labels<span class="op">=</span>[<span class="st">&#39;W&#39;</span>],average<span class="op">=</span><span class="st">&#39;macro&#39;</span>)</span>
<span id="cb25-25"><a href="optimization.html#cb25-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-26"><a href="optimization.html#cb25-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> {<span class="st">&#39;accuracy&#39;</span>:accuracy,<span class="st">&#39;f1&#39;</span>:f1,<span class="st">&#39;kappa&#39;</span>:kappa,</span>
<span id="cb25-27"><a href="optimization.html#cb25-27" aria-hidden="true" tabindex="-1"></a>          <span class="st">&#39;accuracy_ann&#39;</span>:accuracy_ann,<span class="st">&#39;f1_ann&#39;</span>:f1_ann,<span class="st">&#39;kappa_ann&#39;</span>:kappa_ann,</span>
<span id="cb25-28"><a href="optimization.html#cb25-28" aria-hidden="true" tabindex="-1"></a>          <span class="st">&#39;f1_annH&#39;</span>:f1_annH,<span class="st">&#39;f1_annW&#39;</span>:f1_annW,<span class="st">&#39;f1_H&#39;</span>:f1H,<span class="st">&#39;f1_W&#39;</span>:f1W}</span></code></pre></div>
</div>
<div id="performance-error-estimates-and-bootstrapping" class="section level3" number="8.2.2">
<h3><span class="header-section-number">8.2.2</span> Performance error estimates and bootstrapping</h3>
<p>As an estimate for the performance variability induced by the selected sample of individuals we use a standard bootstrapping procedure, resampling with replacement for 100 different times the individuals from those present in the validation set. Resampling is performed in such a way that guarantees the balance across activity-buckets.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb26-1"><a href="optimization.html#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sample_shuffled_fraction_by_group(df_group,fraction<span class="op">=</span><span class="dv">1</span>,replace<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb26-2"><a href="optimization.html#cb26-2" aria-hidden="true" tabindex="-1"></a>  size <span class="op">=</span> <span class="bu">int</span>(df_group.user_id.unique().size<span class="op">*</span>fraction)</span>
<span id="cb26-3"><a href="optimization.html#cb26-3" aria-hidden="true" tabindex="-1"></a>  sampled_users <span class="op">=</span> np.random.choice(df_group.user_id.unique(),replace<span class="op">=</span>replace,size <span class="op">=</span> size)</span>
<span id="cb26-4"><a href="optimization.html#cb26-4" aria-hidden="true" tabindex="-1"></a>  df_res <span class="op">=</span> df_group.set_index(<span class="st">&#39;user_id&#39;</span>)</span>
<span id="cb26-5"><a href="optimization.html#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> df_res.loc[sampled_users].reset_index()</span>
<span id="cb26-6"><a href="optimization.html#cb26-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-7"><a href="optimization.html#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> balanced_bootstrapping(df_man, num_sample<span class="op">=</span><span class="dv">100</span>, metrics<span class="op">=</span><span class="va">True</span>, col_true<span class="op">=</span><span class="st">&#39;FinalOpinion&#39;</span>, col_eval1<span class="op">=</span><span class="st">&#39;FirstOpinion&#39;</span>):</span>
<span id="cb26-8"><a href="optimization.html#cb26-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="kw">not</span> metrics: df_res <span class="op">=</span> pd.DataFrame(columns<span class="op">=</span>df_man.columns<span class="op">+</span>[<span class="st">&#39;sample&#39;</span>])</span>
<span id="cb26-9"><a href="optimization.html#cb26-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>:           df_res <span class="op">=</span> pd.DataFrame(columns<span class="op">=</span>[<span class="st">&#39;sample&#39;</span>,<span class="st">&#39;accuracy&#39;</span>,<span class="st">&#39;f1&#39;</span>,<span class="st">&#39;kappa&#39;</span>])</span>
<span id="cb26-10"><a href="optimization.html#cb26-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> i_sample <span class="kw">in</span> <span class="bu">range</span>(num_sample):</span>
<span id="cb26-11"><a href="optimization.html#cb26-11" aria-hidden="true" tabindex="-1"></a>    df_samp_res <span class="op">=</span> df_man.groupby(<span class="st">&#39;act_buck&#39;</span>,as_index<span class="op">=</span><span class="va">False</span>).<span class="bu">apply</span>(sample_shuffled_fraction_by_group).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb26-12"><a href="optimization.html#cb26-12" aria-hidden="true" tabindex="-1"></a>    df_samp_res[<span class="st">&#39;sample&#39;</span>] <span class="op">=</span> i_sample<span class="op">+</span><span class="dv">1</span></span>
<span id="cb26-13"><a href="optimization.html#cb26-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> metrics: df_res <span class="op">=</span> df_res.append(df_samp_res)</span>
<span id="cb26-14"><a href="optimization.html#cb26-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:           df_res <span class="op">=</span> df_res.append({<span class="st">&#39;sample&#39;</span>:i_sample<span class="op">+</span><span class="dv">1</span>,<span class="op">**</span>compute_sample_metrics(df_samp_res,col_true,col_eval1)},ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb26-15"><a href="optimization.html#cb26-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> df_res</span></code></pre></div>
<p>For each parameter configuration bootstrap is performed and results are structured and stored in the form of a dictionary.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb27-1"><a href="optimization.html#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_multi_config_metrics(<span class="op">**</span>args):</span>
<span id="cb27-2"><a href="optimization.html#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initialize variables from passed &quot;args&quot; dict</span></span>
<span id="cb27-3"><a href="optimization.html#cb27-3" aria-hidden="true" tabindex="-1"></a>  country<span class="op">=</span>args[<span class="st">&quot;country&quot;</span>]</span>
<span id="cb27-4"><a href="optimization.html#cb27-4" aria-hidden="true" tabindex="-1"></a>  manual_labels<span class="op">=</span>args[<span class="st">&quot;manual_labels&quot;</span>]</span>
<span id="cb27-5"><a href="optimization.html#cb27-5" aria-hidden="true" tabindex="-1"></a>  act_buckets <span class="op">=</span> args[<span class="st">&#39;activity_bucket&#39;</span>]</span>
<span id="cb27-6"><a href="optimization.html#cb27-6" aria-hidden="true" tabindex="-1"></a>  df_hw <span class="op">=</span> get_algorithm_labels(<span class="op">**</span>args)</span>
<span id="cb27-7"><a href="optimization.html#cb27-7" aria-hidden="true" tabindex="-1"></a>  df_hw[<span class="st">&#39;act_buck&#39;</span>] <span class="op">=</span> df_hw.user_id.<span class="bu">map</span>(act_buckets)</span>
<span id="cb27-8"><a href="optimization.html#cb27-8" aria-hidden="true" tabindex="-1"></a>  col_true <span class="op">=</span> args[<span class="st">&#39;col_true&#39;</span>]</span>
<span id="cb27-9"><a href="optimization.html#cb27-9" aria-hidden="true" tabindex="-1"></a>  col_eval1 <span class="op">=</span> args[<span class="st">&#39;col_eval1&#39;</span>]</span>
<span id="cb27-10"><a href="optimization.html#cb27-10" aria-hidden="true" tabindex="-1"></a>  col_eval2 <span class="op">=</span> args[<span class="st">&#39;col_eval2&#39;</span>]</span>
<span id="cb27-11"><a href="optimization.html#cb27-11" aria-hidden="true" tabindex="-1"></a>  numer_of_samples <span class="op">=</span> args[<span class="st">&#39;numer_of_samples&#39;</span>]</span>
<span id="cb27-12"><a href="optimization.html#cb27-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-13"><a href="optimization.html#cb27-13" aria-hidden="true" tabindex="-1"></a>  df_compare <span class="op">=</span> (pd.merge(manual_labels, df_hw, how<span class="op">=</span><span class="st">&quot;outer&quot;</span>, on<span class="op">=</span>[<span class="st">&quot;user_id&quot;</span>, <span class="st">&quot;cluster_label&quot;</span>,<span class="st">&quot;act_buck&quot;</span>])</span>
<span id="cb27-14"><a href="optimization.html#cb27-14" aria-hidden="true" tabindex="-1"></a>                .sort_values(by<span class="op">=</span>[<span class="st">&quot;user_id&quot;</span>,<span class="st">&quot;cluster_label&quot;</span>,<span class="st">&quot;FinalOpinion&quot;</span>,<span class="st">&quot;AlgorithmOpinion&quot;</span>])</span>
<span id="cb27-15"><a href="optimization.html#cb27-15" aria-hidden="true" tabindex="-1"></a>                .drop_duplicates(subset<span class="op">=</span>[<span class="st">&quot;user_id&quot;</span>,<span class="st">&quot;cluster_label&quot;</span>])</span>
<span id="cb27-16"><a href="optimization.html#cb27-16" aria-hidden="true" tabindex="-1"></a>                .reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb27-17"><a href="optimization.html#cb27-17" aria-hidden="true" tabindex="-1"></a>                .fillna({<span class="st">&#39;Country&#39;</span>:country,<span class="st">&#39;FirstOpinion&#39;</span>:<span class="st">&#39;O&#39;</span>,<span class="st">&#39;SecondOpinion&#39;</span>:<span class="st">&#39;O&#39;</span>,<span class="st">&#39;AlgorithmOpinion&#39;</span>:<span class="st">&#39;O&#39;</span>,<span class="st">&#39;FinalOpinion&#39;</span>:<span class="st">&#39;O&#39;</span>}))</span>
<span id="cb27-18"><a href="optimization.html#cb27-18" aria-hidden="true" tabindex="-1"></a>  df_compare <span class="op">=</span> df_compare[(df_compare.FinalOpinion<span class="op">!=</span><span class="st">&#39;O&#39;</span>)<span class="op">|</span>(df_compare.AlgorithmOpinion<span class="op">!=</span><span class="st">&#39;O&#39;</span>)]</span>
<span id="cb27-19"><a href="optimization.html#cb27-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-20"><a href="optimization.html#cb27-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute performance metrics</span></span>
<span id="cb27-21"><a href="optimization.html#cb27-21" aria-hidden="true" tabindex="-1"></a>  accuracy <span class="op">=</span> skm.accuracy_score(df_compare[col_true], df_compare[col_eval1])</span>
<span id="cb27-22"><a href="optimization.html#cb27-22" aria-hidden="true" tabindex="-1"></a>  kappa <span class="op">=</span> (skm.cohen_kappa_score(df_compare[<span class="st">&#39;FirstOpinion&#39;</span>], df_compare[col_eval1])<span class="op">+</span>skm.cohen_kappa_score(df_compare[<span class="st">&#39;SecondOpinion&#39;</span>], df_compare[col_eval1]))<span class="op">/</span><span class="dv">2</span></span>
<span id="cb27-23"><a href="optimization.html#cb27-23" aria-hidden="true" tabindex="-1"></a>  recall <span class="op">=</span> skm.recall_score(df_compare[col_true], df_compare[col_eval1],labels<span class="op">=</span>[<span class="st">&#39;H&#39;</span>,<span class="st">&#39;W&#39;</span>], average<span class="op">=</span><span class="st">&quot;macro&quot;</span>)</span>
<span id="cb27-24"><a href="optimization.html#cb27-24" aria-hidden="true" tabindex="-1"></a>  precision <span class="op">=</span> skm.precision_score(df_compare[col_true], df_compare[col_eval1],labels<span class="op">=</span>[<span class="st">&#39;H&#39;</span>,<span class="st">&#39;W&#39;</span>], average<span class="op">=</span><span class="st">&quot;macro&quot;</span>)</span>
<span id="cb27-25"><a href="optimization.html#cb27-25" aria-hidden="true" tabindex="-1"></a>  f1 <span class="op">=</span> skm.f1_score(df_compare[col_true], df_compare[col_eval1],labels<span class="op">=</span>[<span class="st">&#39;H&#39;</span>,<span class="st">&#39;W&#39;</span>], average<span class="op">=</span><span class="st">&quot;macro&quot;</span>)</span>
<span id="cb27-26"><a href="optimization.html#cb27-26" aria-hidden="true" tabindex="-1"></a>  cf <span class="op">=</span> skm.confusion_matrix(df_compare[col_true], df_compare[col_eval1])</span>
<span id="cb27-27"><a href="optimization.html#cb27-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-28"><a href="optimization.html#cb27-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Estimate performance errors via Bootstrapping</span></span>
<span id="cb27-29"><a href="optimization.html#cb27-29" aria-hidden="true" tabindex="-1"></a>  res <span class="op">=</span> balanced_bootstrapping(df_compare,num_sample<span class="op">=</span>numer_of_samples,col_true<span class="op">=</span>col_true,col_eval1<span class="op">=</span>col_eval1)</span>
<span id="cb27-30"><a href="optimization.html#cb27-30" aria-hidden="true" tabindex="-1"></a>  m <span class="op">=</span> res.mean().iloc[<span class="dv">1</span>:]</span>
<span id="cb27-31"><a href="optimization.html#cb27-31" aria-hidden="true" tabindex="-1"></a>  m <span class="op">=</span> m.sort_index()</span>
<span id="cb27-32"><a href="optimization.html#cb27-32" aria-hidden="true" tabindex="-1"></a>  m.index<span class="op">=</span>[<span class="st">&#39;fold_acc&#39;</span>,<span class="st">&#39;fold_annotators_acc&#39;</span>,<span class="st">&#39;fold_f1&#39;</span>,<span class="st">&#39;fold_f1H&#39;</span>,<span class="st">&#39;fold_f1W&#39;</span>,<span class="st">&#39;fold_annotators_f1&#39;</span>,<span class="st">&#39;fold_annotators_f1H&#39;</span>,<span class="st">&#39;fold_annotators_f1W&#39;</span>,<span class="st">&#39;fold_kap&#39;</span>,<span class="st">&#39;fold_annotators_kap&#39;</span>]</span>
<span id="cb27-33"><a href="optimization.html#cb27-33" aria-hidden="true" tabindex="-1"></a>  s <span class="op">=</span> res.std().iloc[<span class="dv">1</span>:]</span>
<span id="cb27-34"><a href="optimization.html#cb27-34" aria-hidden="true" tabindex="-1"></a>  s <span class="op">=</span> s.sort_index()</span>
<span id="cb27-35"><a href="optimization.html#cb27-35" aria-hidden="true" tabindex="-1"></a>  s.index<span class="op">=</span>[<span class="st">&#39;fold_acc_std&#39;</span>,<span class="st">&#39;fold_annotators_acc_std&#39;</span>,<span class="st">&#39;fold_f1_std&#39;</span>,<span class="st">&#39;fold_f1H_std&#39;</span>,<span class="st">&#39;fold_f1W_std&#39;</span>,<span class="st">&#39;fold_annotators_f1_std&#39;</span>,<span class="st">&#39;fold_annotators_f1H_std&#39;</span>,<span class="st">&#39;fold_annotators_f1W_std&#39;</span>,<span class="st">&#39;fold_kap_std&#39;</span>,<span class="st">&#39;fold_annotators_kap_std&#39;</span>]</span>
<span id="cb27-36"><a href="optimization.html#cb27-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-37"><a href="optimization.html#cb27-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Collect and structure results into a dictionary</span></span>
<span id="cb27-38"><a href="optimization.html#cb27-38" aria-hidden="true" tabindex="-1"></a>  the_dict <span class="op">=</span> {<span class="st">&quot;country&quot;</span>:country,</span>
<span id="cb27-39"><a href="optimization.html#cb27-39" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;home_period_window&quot;</span>:<span class="bu">int</span>(args[<span class="st">&#39;home_period_window&#39;</span>]),</span>
<span id="cb27-40"><a href="optimization.html#cb27-40" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;work_period_window&quot;</span>:<span class="bu">int</span>(args[<span class="st">&#39;work_period_window&#39;</span>]),</span>
<span id="cb27-41"><a href="optimization.html#cb27-41" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;min_periods_over_window&quot;</span>:<span class="bu">float</span>(args[<span class="st">&#39;min_periods_over_window&#39;</span>]),</span>
<span id="cb27-42"><a href="optimization.html#cb27-42" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;min_periods_over_window_work&quot;</span>:<span class="bu">float</span>(args[<span class="st">&#39;min_periods_over_window_work&#39;</span>]),</span>
<span id="cb27-43"><a href="optimization.html#cb27-43" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;work_activity_average&quot;</span>:<span class="bu">float</span>(args[<span class="st">&#39;work_activity_average&#39;</span>]),</span>
<span id="cb27-44"><a href="optimization.html#cb27-44" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;time_fraction_work&quot;</span>:<span class="bu">float</span>(args[<span class="st">&#39;time_fraction_work&#39;</span>]),</span>
<span id="cb27-45"><a href="optimization.html#cb27-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-46"><a href="optimization.html#cb27-46" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;f1&quot;</span>:f1,<span class="st">&quot;accuracy&quot;</span>:accuracy,<span class="st">&quot;kappa&quot;</span>:kappa,</span>
<span id="cb27-47"><a href="optimization.html#cb27-47" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;cf&quot;</span>:cf,<span class="op">**</span>m,<span class="op">**</span>s}</span>
<span id="cb27-48"><a href="optimization.html#cb27-48" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> the_dict</span></code></pre></div>
</div>
<div id="parallel-bootstrapping-and-optimization-result-storage" class="section level3" number="8.2.3">
<h3><span class="header-section-number">8.2.3</span> Parallel bootstrapping and optimization result storage</h3>
<p>The enormous number of combination of parameter configuration we have to explore can be speeded up by multiprocess computation of the different configurations. Here, we present a possible solution which uses the [python “joblib” library]{<a href="https://joblib.readthedocs.io/en/latest/" class="uri">https://joblib.readthedocs.io/en/latest/</a>}.
Parameter configurations are stored as a list of dictionaries which is then passed to the “Parallel” function.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb28-1"><a href="optimization.html#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> joblib <span class="im">import</span> Parallel,delayed</span>
<span id="cb28-2"><a href="optimization.html#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="optimization.html#cb28-3" aria-hidden="true" tabindex="-1"></a>results_save_path <span class="op">=</span> <span class="st">&quot;SAVING_PATH_FOR_CONFIGURATION_PERFORMANCE_EVALUTATION&quot;</span></span>
<span id="cb28-4"><a href="optimization.html#cb28-4" aria-hidden="true" tabindex="-1"></a>numer_of_samples <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb28-5"><a href="optimization.html#cb28-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-6"><a href="optimization.html#cb28-6" aria-hidden="true" tabindex="-1"></a>c_dates <span class="op">=</span> {<span class="st">&#39;BR&#39;</span>: <span class="st">&#39;2021-01-01&#39;</span>, <span class="st">&#39;CO&#39;</span>: <span class="st">&#39;2021-01-01&#39;</span>, <span class="st">&#39;ID&#39;</span>: <span class="st">&#39;2021-01-01&#39;</span>,</span>
<span id="cb28-7"><a href="optimization.html#cb28-7" aria-hidden="true" tabindex="-1"></a>           <span class="st">&#39;ZA&#39;</span>: <span class="st">&#39;2021-01-01&#39;</span>, <span class="st">&#39;MX&#39;</span>: <span class="st">&#39;2020-12-01&#39;</span>, <span class="st">&#39;PH&#39;</span>: <span class="st">&#39;2021-01-01&#39;</span>}</span>
<span id="cb28-8"><a href="optimization.html#cb28-8" aria-hidden="true" tabindex="-1"></a>countries <span class="op">=</span> [<span class="st">&#39;CO&#39;</span>,<span class="st">&#39;PH&#39;</span>,<span class="st">&#39;MX&#39;</span>,<span class="st">&#39;BR&#39;</span>,<span class="st">&#39;ID&#39;</span>]</span>
<span id="cb28-9"><a href="optimization.html#cb28-9" aria-hidden="true" tabindex="-1"></a>result_list <span class="op">=</span> []</span>
<span id="cb28-10"><a href="optimization.html#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> country <span class="kw">in</span> countries:</span>
<span id="cb28-11"><a href="optimization.html#cb28-11" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(country)</span>
<span id="cb28-12"><a href="optimization.html#cb28-12" aria-hidden="true" tabindex="-1"></a>  df_man <span class="op">=</span>  get_labels(country)</span>
<span id="cb28-13"><a href="optimization.html#cb28-13" aria-hidden="true" tabindex="-1"></a>  activity_bucket <span class="op">=</span> df_man.drop_duplicates([<span class="st">&#39;user_id&#39;</span>,<span class="st">&#39;act_buck&#39;</span>]).set_index(<span class="st">&#39;user_id&#39;</span>).act_buck.dropna().to_dict()</span>
<span id="cb28-14"><a href="optimization.html#cb28-14" aria-hidden="true" tabindex="-1"></a>  init_params <span class="op">=</span> {<span class="st">&quot;country&quot;</span>:[country],<span class="st">&quot;c_dates&quot;</span>:[c_dates]}</span>
<span id="cb28-15"><a href="optimization.html#cb28-15" aria-hidden="true" tabindex="-1"></a>  parameters <span class="op">=</span> {<span class="op">**</span>init_params, <span class="op">**</span>iter_params}</span>
<span id="cb28-16"><a href="optimization.html#cb28-16" aria-hidden="true" tabindex="-1"></a>  additional_params <span class="op">=</span> {<span class="st">&quot;numer_of_samples&quot;</span>:numer_of_samples,<span class="st">&quot;activity_bucket&quot;</span>:activity_bucket,<span class="st">&quot;manual_labels&quot;</span>:df_man, </span>
<span id="cb28-17"><a href="optimization.html#cb28-17" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;col_true&#39;</span>:<span class="st">&#39;FinalOpinion&#39;</span>,<span class="st">&#39;col_eval1&#39;</span>:<span class="st">&#39;AlgorithmOpinion&#39;</span>,<span class="st">&#39;col_eval2&#39;</span>:<span class="va">None</span>}</span>
<span id="cb28-18"><a href="optimization.html#cb28-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-19"><a href="optimization.html#cb28-19" aria-hidden="true" tabindex="-1"></a>  results_df <span class="op">=</span> pd.DataFrame(columns<span class="op">=</span>[<span class="st">&quot;country&quot;</span>, <span class="st">&quot;home_period_window&quot;</span>, <span class="st">&quot;work_period_window&quot;</span>, <span class="st">&quot;min_periods_over_window&quot;</span>, <span class="st">&quot;min_periods_over_window_work&quot;</span>, <span class="st">&quot;work_activity_average&quot;</span>, <span class="st">&quot;time_fraction_work&quot;</span>, <span class="st">&quot;accuracy&quot;</span>, <span class="st">&quot;recall&quot;</span>, <span class="st">&quot;precision&quot;</span>, <span class="st">&quot;f1&quot;</span>, <span class="st">&quot;fold_f1&quot;</span>,<span class="st">&quot;fold_acc&quot;</span>,<span class="st">&quot;fold_kap&quot;</span>,<span class="st">&quot;fold_f1_sem&quot;</span>,<span class="st">&quot;fold_acc_sem&quot;</span>,<span class="st">&quot;fold_kap_sem&quot;</span>, <span class="st">&quot;cf&quot;</span>])</span>
<span id="cb28-20"><a href="optimization.html#cb28-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-21"><a href="optimization.html#cb28-21" aria-hidden="true" tabindex="-1"></a>  keys <span class="op">=</span> <span class="bu">list</span>(parameters)</span>
<span id="cb28-22"><a href="optimization.html#cb28-22" aria-hidden="true" tabindex="-1"></a>  keyvals <span class="op">=</span> []</span>
<span id="cb28-23"><a href="optimization.html#cb28-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> values <span class="kw">in</span> itertools.product(<span class="op">*</span><span class="bu">map</span>(parameters.get, keys)):</span>
<span id="cb28-24"><a href="optimization.html#cb28-24" aria-hidden="true" tabindex="-1"></a>    keyval <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">zip</span>(keys, values))</span>
<span id="cb28-25"><a href="optimization.html#cb28-25" aria-hidden="true" tabindex="-1"></a>    keyval <span class="op">=</span> {k:<span class="bu">str</span>(v) <span class="cf">for</span> k, v <span class="kw">in</span> keyval.items()}</span>
<span id="cb28-26"><a href="optimization.html#cb28-26" aria-hidden="true" tabindex="-1"></a>    keyval <span class="op">=</span> {<span class="op">**</span>keyval,<span class="op">**</span>additional_params}</span>
<span id="cb28-27"><a href="optimization.html#cb28-27" aria-hidden="true" tabindex="-1"></a>    keyvals.append(keyval)</span>
<span id="cb28-28"><a href="optimization.html#cb28-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-29"><a href="optimization.html#cb28-29" aria-hidden="true" tabindex="-1"></a>  result_list <span class="op">+=</span> Parallel(n_jobs<span class="op">=</span><span class="dv">32</span>)(delayed(get_multi_config_metrics)(<span class="op">**</span>keyval) <span class="cf">for</span> j,keyval <span class="kw">in</span> <span class="bu">enumerate</span>(keyvals[:]))</span>
<span id="cb28-30"><a href="optimization.html#cb28-30" aria-hidden="true" tabindex="-1"></a>results_df <span class="op">=</span> pd.DataFrame.from_records(result_list)</span>
<span id="cb28-31"><a href="optimization.html#cb28-31" aria-hidden="true" tabindex="-1"></a>results_df[<span class="st">&#39;samples&#39;</span>] <span class="op">=</span> numer_of_samples</span>
<span id="cb28-32"><a href="optimization.html#cb28-32" aria-hidden="true" tabindex="-1"></a>results_df.to_csv(results_save_path<span class="op">+</span><span class="ss">f&quot;final_statistics_with_</span><span class="sc">{</span>numer_of_samples<span class="sc">}</span><span class="ss">_folding_v10.csv&quot;</span>, index<span class="op">=</span><span class="va">False</span>)</span></code></pre></div>
</div>
</div>
<div id="parameter-configuration-selection" class="section level2" number="8.3">
<h2><span class="header-section-number">8.3</span> Parameter configuration selection</h2>
<p>While for each country a different optimal configuration can be found, leveraging over the performance error estimates, it is possible to check for common configuartions across different countries which are compatible (i.e. the difference between the optimal configuration F1 minus its standard deviation is smaller than the shared configuration plus its standard deviation) with the country specific best configuration. Best configuration is selected among those compatible for all states by means of the harmonic average of each country F1 score.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb29-1"><a href="optimization.html#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_country_compatibilities(res_country):</span>
<span id="cb29-2"><a href="optimization.html#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">&#39;&#39;&#39;</span></span>
<span id="cb29-3"><a href="optimization.html#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="co">    INPUT:  pandas dataframe resulting from bootstrapped optimization</span></span>
<span id="cb29-4"><a href="optimization.html#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="co">    OUTPUT: pandas dataframe filtered to keep only configurations which are compatible with the best one</span></span>
<span id="cb29-5"><a href="optimization.html#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="co">  &#39;&#39;&#39;</span></span>
<span id="cb29-6"><a href="optimization.html#cb29-6" aria-hidden="true" tabindex="-1"></a>  arg_max <span class="op">=</span> res_country.loc[res_country.fold_f1.idxmax()]</span>
<span id="cb29-7"><a href="optimization.html#cb29-7" aria-hidden="true" tabindex="-1"></a>  results_df_fold_f1_max <span class="op">=</span> arg_max.fold_f1</span>
<span id="cb29-8"><a href="optimization.html#cb29-8" aria-hidden="true" tabindex="-1"></a>  results_df_fold_f1_mstd <span class="op">=</span> arg_max.fold_f1_std</span>
<span id="cb29-9"><a href="optimization.html#cb29-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> res_country[res_country.fold_f1<span class="op">+</span>res_country.fold_f1_std<span class="op">&gt;=</span>results_df_fold_f1_max<span class="op">-</span>results_df_fold_f1_mstd]</span></code></pre></div>
<p>We report here, an example to get (if any) a common best parameter configuration for five different countries, namely, Mexico, Brazil, Indonesia, Philippines, and Colombia.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb30-1"><a href="optimization.html#cb30-1" aria-hidden="true" tabindex="-1"></a>countries <span class="op">=</span> [<span class="st">&#39;MX&#39;</span>,<span class="st">&#39;BR&#39;</span>,<span class="st">&#39;ID&#39;</span>,<span class="st">&#39;PH&#39;</span>,<span class="st">&#39;CO&#39;</span>]</span>
<span id="cb30-2"><a href="optimization.html#cb30-2" aria-hidden="true" tabindex="-1"></a>numer_of_samples <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb30-3"><a href="optimization.html#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="optimization.html#cb30-4" aria-hidden="true" tabindex="-1"></a>results_df <span class="op">=</span> pd.read_csv(results_save_path<span class="op">+</span><span class="ss">f&quot;final_statistics_with_</span><span class="sc">{</span>numer_of_samples<span class="sc">}</span><span class="ss">_folding_v10.csv&quot;</span>)</span>
<span id="cb30-5"><a href="optimization.html#cb30-5" aria-hidden="true" tabindex="-1"></a>res_opt <span class="op">=</span> results_df.groupby(<span class="st">&#39;country&#39;</span>,as_index<span class="op">=</span><span class="va">False</span>).<span class="bu">apply</span>(get_country_compatibilities)</span>
<span id="cb30-6"><a href="optimization.html#cb30-6" aria-hidden="true" tabindex="-1"></a>res_opt <span class="op">=</span> res_opt.set_index([<span class="st">&#39;country&#39;</span>,<span class="st">&quot;home_period_window&quot;</span>,<span class="st">&quot;work_period_window&quot;</span>,</span>
<span id="cb30-7"><a href="optimization.html#cb30-7" aria-hidden="true" tabindex="-1"></a>                             <span class="st">&quot;min_periods_over_window&quot;</span>,<span class="st">&quot;min_periods_over_window_work&quot;</span>,</span>
<span id="cb30-8"><a href="optimization.html#cb30-8" aria-hidden="true" tabindex="-1"></a>                             <span class="st">&quot;work_activity_average&quot;</span>,<span class="st">&quot;time_fraction_work&quot;</span>])</span>
<span id="cb30-9"><a href="optimization.html#cb30-9" aria-hidden="true" tabindex="-1"></a>                             </span>
<span id="cb30-10"><a href="optimization.html#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="co">### Find the best common optimum (optimization function is the max of the average f1 score)</span></span>
<span id="cb30-11"><a href="optimization.html#cb30-11" aria-hidden="true" tabindex="-1"></a>res_tmp <span class="op">=</span> results_df.drop_duplicates([<span class="st">&quot;country&quot;</span>,<span class="st">&quot;home_period_window&quot;</span>, <span class="st">&quot;work_period_window&quot;</span>, <span class="st">&quot;min_periods_over_window&quot;</span>, <span class="st">&quot;min_periods_over_window_work&quot;</span>, <span class="st">&quot;work_activity_average&quot;</span>,<span class="st">&quot;time_fraction_work&quot;</span>])</span>
<span id="cb30-12"><a href="optimization.html#cb30-12" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> res_tmp.groupby([<span class="st">&quot;home_period_window&quot;</span>, <span class="st">&quot;work_period_window&quot;</span>, <span class="st">&quot;min_periods_over_window&quot;</span>, <span class="st">&quot;min_periods_over_window_work&quot;</span>, <span class="st">&quot;work_activity_average&quot;</span>,<span class="st">&quot;time_fraction_work&quot;</span>]).mean()</span>
<span id="cb30-13"><a href="optimization.html#cb30-13" aria-hidden="true" tabindex="-1"></a>res[<span class="st">&#39;fold_f1_harmonic&#39;</span>] <span class="op">=</span> res_tmp.groupby([<span class="st">&quot;home_period_window&quot;</span>, <span class="st">&quot;work_period_window&quot;</span>, <span class="st">&quot;min_periods_over_window&quot;</span>, <span class="st">&quot;min_periods_over_window_work&quot;</span>, <span class="st">&quot;work_activity_average&quot;</span>,<span class="st">&quot;time_fraction_work&quot;</span>]).fold_f1.<span class="bu">apply</span>(hmean)</span>
<span id="cb30-14"><a href="optimization.html#cb30-14" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> res.sort_values(<span class="st">&#39;fold_f1_harmonic&#39;</span>,ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb30-15"><a href="optimization.html#cb30-15" aria-hidden="true" tabindex="-1"></a>res.reset_index(inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb30-16"><a href="optimization.html#cb30-16" aria-hidden="true" tabindex="-1"></a>i<span class="op">=</span><span class="dv">0</span></span>
<span id="cb30-17"><a href="optimization.html#cb30-17" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb30-18"><a href="optimization.html#cb30-18" aria-hidden="true" tabindex="-1"></a>    test_index <span class="op">=</span> res.iloc[i][[<span class="st">&quot;home_period_window&quot;</span>, <span class="st">&quot;work_period_window&quot;</span>, <span class="st">&quot;min_periods_over_window&quot;</span>, <span class="st">&quot;min_periods_over_window_work&quot;</span>, <span class="st">&quot;work_activity_average&quot;</span>,<span class="st">&quot;time_fraction_work&quot;</span>]].tolist()</span>
<span id="cb30-19"><a href="optimization.html#cb30-19" aria-hidden="true" tabindex="-1"></a>    testing<span class="op">=</span>[]</span>
<span id="cb30-20"><a href="optimization.html#cb30-20" aria-hidden="true" tabindex="-1"></a>    j<span class="op">=</span><span class="dv">0</span></span>
<span id="cb30-21"><a href="optimization.html#cb30-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> country <span class="kw">in</span> countries:</span>
<span id="cb30-22"><a href="optimization.html#cb30-22" aria-hidden="true" tabindex="-1"></a>      test <span class="op">=</span> <span class="bu">tuple</span>([country]<span class="op">+</span>test_index)</span>
<span id="cb30-23"><a href="optimization.html#cb30-23" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> test <span class="kw">in</span> res_opt.index.tolist(): j<span class="op">+=</span><span class="dv">1</span></span>
<span id="cb30-24"><a href="optimization.html#cb30-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> j <span class="op">==</span> <span class="bu">len</span>(countries):        <span class="bu">print</span>(<span class="ss">f&quot;Best common config found: </span><span class="sc">{i}</span><span class="ss">: </span><span class="sc">{</span>test_index<span class="sc">}</span><span class="ss">&quot;</span>)<span class="op">;</span> <span class="cf">break</span></span>
<span id="cb30-25"><a href="optimization.html#cb30-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>: i<span class="op">+=</span><span class="dv">1</span></span>
<span id="cb30-26"><a href="optimization.html#cb30-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> i<span class="op">&gt;</span><span class="dv">10000</span>: <span class="bu">print</span>(<span class="st">&#39;Maximum iterations Exceeded. No common optimum found, increase/modify acceptance region!&#39;</span>)<span class="op">;</span> <span class="cf">break</span></span></code></pre></div>
<p>In our case, the best common configiguration found is:
- home_period_window: 49.0,
- work_period_window: 49.0,
- min_periods_over_window: 0.2,
- min_periods_over_window_work: 0.2,
- work_activity_average: 3600.0,
- time_fraction_work: 0.0</p>
<p>These values are the one used to label the locations in the analysis presented in the book.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="migration.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="windex.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/worldbank/SDG-big-data/tree/GPS-analytics/07-optimization.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["gps-mobility.pdf", "gps-mobility.epub"],
"search": {
"engine": "lunr",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
