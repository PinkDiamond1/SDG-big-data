<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 2 Training data preparation | Twitter Analytics</title>
  <meta name="description" content="Guided step by step analysis of the labor market using NLP on Twitter data." />
  <meta name="generator" content="bookdown 0.23 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 2 Training data preparation | Twitter Analytics" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Guided step by step analysis of the labor market using NLP on Twitter data." />
  <meta name="github-repo" content="rstudio/bookdown-demo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 2 Training data preparation | Twitter Analytics" />
  
  <meta name="twitter:description" content="Guided step by step analysis of the labor market using NLP on Twitter data." />
  

<meta name="author" content="Chapter 2 Training data preparation | Twitter Analytics Group" />


<meta name="date" content="2021-08-26" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="index.html"/>
<link rel="next" href="finetuning-bert-based-models.html"/>
<script src="libs/header-attrs-2.10/header-attrs.js"></script>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">GPS Mobility Analysis</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Labor market analysis with Twitter data</a></li>
<li class="chapter" data-level="2" data-path="training-data-preparation.html"><a href="training-data-preparation.html"><i class="fa fa-check"></i><b>2</b> Training data preparation</a>
<ul>
<li class="chapter" data-level="2.1" data-path="training-data-preparation.html"><a href="training-data-preparation.html#sampling"><i class="fa fa-check"></i><b>2.1</b> Sampling</a></li>
<li class="chapter" data-level="2.2" data-path="training-data-preparation.html"><a href="training-data-preparation.html#labelling"><i class="fa fa-check"></i><b>2.2</b> Labelling</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="training-data-preparation.html"><a href="training-data-preparation.html#creating-a-qualtrics-survey"><i class="fa fa-check"></i><b>2.2.1</b> Creating a Qualtrics survey</a></li>
<li class="chapter" data-level="2.2.2" data-path="training-data-preparation.html"><a href="training-data-preparation.html#sharing-the-survey-on-mturk"><i class="fa fa-check"></i><b>2.2.2</b> Sharing the survey on MTurk</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="finetuning-bert-based-models.html"><a href="finetuning-bert-based-models.html"><i class="fa fa-check"></i><b>3</b> Finetuning BERT-based models</a>
<ul>
<li class="chapter" data-level="3.1" data-path="finetuning-bert-based-models.html"><a href="finetuning-bert-based-models.html#training-the-model"><i class="fa fa-check"></i><b>3.1</b> Training the model</a></li>
<li class="chapter" data-level="3.2" data-path="finetuning-bert-based-models.html"><a href="finetuning-bert-based-models.html#evaluation-on-the-random-set"><i class="fa fa-check"></i><b>3.2</b> Evaluation on the random set</a></li>
<li class="chapter" data-level="3.3" data-path="finetuning-bert-based-models.html"><a href="finetuning-bert-based-models.html#active-learning"><i class="fa fa-check"></i><b>3.3</b> Active learning</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="labor-market-analysis-with-twitter-data-1.html"><a href="labor-market-analysis-with-twitter-data-1.html"><i class="fa fa-check"></i><b>4</b> Labor market analysis with Twitter data</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Twitter Analytics</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="training-data-preparation" class="section level1" number="2">
<h1><span class="header-section-number">Chapter 2</span> Training data preparation</h1>
<div id="sampling" class="section level2" number="2.1">
<h2><span class="header-section-number">2.1</span> Sampling</h2>
<p>The first step in order to train classifiers to detect disclosures of labor market situation is to sample informative tweets and have them labelled. Owing to the very low share of tweets containing these disclosures, a random sampling would yield very few positive examples which would not allow to train a good-performing classifier. We instead decided to opt for stratified sampling, namely by defining a list of n-grams, both specific to the labor market context and frequent enough, and sampling tweets containing these n-grams.</p>
<p>In practice, we wrote code in PySpark as we had to handle big amounts of data. Hereâ€™s a snippet of the code we used: after loading the data in the dataframe <code>df</code> and having <code>text_lowercase</code> as the column where the lowercased text is stored, we define the list of ngrams to sample from and then sample from it.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="training-data-preparation.html#cb1-1" aria-hidden="true" tabindex="-1"></a>ngram_list <span class="op">=</span> [[<span class="st">&#39; i &#39;</span>, <span class="st">&#39;fired &#39;</span>], [<span class="st">&#39;fired me&#39;</span>], [<span class="st">&#39;laid off&#39;</span>], [<span class="st">&#39;lost my job&#39;</span>]]</span>
<span id="cb1-2"><a href="training-data-preparation.html#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ngram <span class="kw">in</span> ngram_list:</span>
<span id="cb1-3"><a href="training-data-preparation.html#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(ngram) <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb1-4"><a href="training-data-preparation.html#cb1-4" aria-hidden="true" tabindex="-1"></a>        df_ngram <span class="op">=</span> df.<span class="bu">filter</span>(df.text_lowercase.contains(ngram[<span class="dv">0</span>]))</span>
<span id="cb1-5"><a href="training-data-preparation.html#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="bu">len</span>(ngram) <span class="op">==</span> <span class="dv">2</span>:</span>
<span id="cb1-6"><a href="training-data-preparation.html#cb1-6" aria-hidden="true" tabindex="-1"></a>        regex <span class="op">=</span> <span class="ss">f&quot;</span><span class="sc">{</span>ngram[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">[.\w\s\d]*</span><span class="sc">{</span>ngram[<span class="dv">1</span>]<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb1-7"><a href="training-data-preparation.html#cb1-7" aria-hidden="true" tabindex="-1"></a>        df_ngram <span class="op">=</span> df.<span class="bu">filter</span>(df.text_lowercase.rlike(regex))</span>
<span id="cb1-8"><a href="training-data-preparation.html#cb1-8" aria-hidden="true" tabindex="-1"></a>    share <span class="op">=</span> <span class="bu">min</span>(<span class="bu">float</span>(<span class="dv">150</span> <span class="op">/</span> df_ngram.count()), <span class="fl">1.0</span>)</span>
<span id="cb1-9"><a href="training-data-preparation.html#cb1-9" aria-hidden="true" tabindex="-1"></a>    df_ngram_sample <span class="op">=</span> df_ngram.sample(<span class="va">False</span>, share, seed<span class="op">=</span><span class="dv">0</span>)</span></code></pre></div>
<p>We sample 150 tweets per n-gram for each class and language. In total, we end up with approximately 5000 samples for each language. A detailed list of n-grams for each language and class can be found in XXXX.</p>
</div>
<div id="labelling" class="section level2" number="2.2">
<h2><span class="header-section-number">2.2</span> Labelling</h2>
<p>After sampling informative tweets, we have them labelled by crowdworkers. We use the crowdsourcing platform Amazon Mechanical Turk. This platform has the advantage of having an international workforce speaking several languages, including Spanish and Brazilian Portuguese on top of English.</p>
<div id="creating-a-qualtrics-survey" class="section level3" number="2.2.1">
<h3><span class="header-section-number">2.2.1</span> Creating a Qualtrics survey</h3>
<p>The first step was to create a survey we would then send to crowdworkers. For this, we use Qualtrics which implies having a Qualtrics API token and a datacenter ID. We build beforehand a survey template one can create manually on Qualtrics that we can then load questions from for the different labelling sessions.</p>
<p>With this information, we are able to create a new blank survey for which we can define the name <code>SurveyName</code> and the <code>language</code>:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="training-data-preparation.html#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_survey(SurveyName, apiToken, dataCenter, language):</span>
<span id="cb2-2"><a href="training-data-preparation.html#cb2-2" aria-hidden="true" tabindex="-1"></a>    baseUrl <span class="op">=</span> <span class="st">&quot;https://</span><span class="sc">{0}</span><span class="st">.qualtrics.com/API/v3/survey-definitions&quot;</span>.<span class="bu">format</span>(</span>
<span id="cb2-3"><a href="training-data-preparation.html#cb2-3" aria-hidden="true" tabindex="-1"></a>        dataCenter)</span>
<span id="cb2-4"><a href="training-data-preparation.html#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="training-data-preparation.html#cb2-5" aria-hidden="true" tabindex="-1"></a>    headers <span class="op">=</span> {</span>
<span id="cb2-6"><a href="training-data-preparation.html#cb2-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;x-api-token&quot;</span>: apiToken,</span>
<span id="cb2-7"><a href="training-data-preparation.html#cb2-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;content-type&quot;</span>: <span class="st">&quot;application/json&quot;</span>,</span>
<span id="cb2-8"><a href="training-data-preparation.html#cb2-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Accept&quot;</span>: <span class="st">&quot;application/json&quot;</span></span>
<span id="cb2-9"><a href="training-data-preparation.html#cb2-9" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-10"><a href="training-data-preparation.html#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="training-data-preparation.html#cb2-11" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> {</span>
<span id="cb2-12"><a href="training-data-preparation.html#cb2-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;SurveyName&quot;</span>: SurveyName,</span>
<span id="cb2-13"><a href="training-data-preparation.html#cb2-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Language&quot;</span>: language,</span>
<span id="cb2-14"><a href="training-data-preparation.html#cb2-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;ProjectCategory&quot;</span>: <span class="st">&quot;CORE&quot;</span></span>
<span id="cb2-15"><a href="training-data-preparation.html#cb2-15" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-16"><a href="training-data-preparation.html#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="training-data-preparation.html#cb2-17" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> requests.post(baseUrl, json<span class="op">=</span>data, headers<span class="op">=</span>headers)</span>
<span id="cb2-18"><a href="training-data-preparation.html#cb2-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-19"><a href="training-data-preparation.html#cb2-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> json.loads(response.text)[<span class="st">&quot;meta&quot;</span>][<span class="st">&quot;httpStatus&quot;</span>] <span class="op">!=</span> <span class="st">&#39;200 - OK&#39;</span>:</span>
<span id="cb2-20"><a href="training-data-preparation.html#cb2-20" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(json.loads(response.text)[<span class="st">&quot;meta&quot;</span>][<span class="st">&quot;httpStatus&quot;</span>])</span>
<span id="cb2-21"><a href="training-data-preparation.html#cb2-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-22"><a href="training-data-preparation.html#cb2-22" aria-hidden="true" tabindex="-1"></a>    SurveyID <span class="op">=</span> json.loads(response.text)[<span class="st">&#39;result&#39;</span>][<span class="st">&#39;SurveyID&#39;</span>]</span>
<span id="cb2-23"><a href="training-data-preparation.html#cb2-23" aria-hidden="true" tabindex="-1"></a>    DefaultBlockID <span class="op">=</span> json.loads(response.text)[<span class="st">&#39;result&#39;</span>][<span class="st">&#39;DefaultBlockID&#39;</span>]</span>
<span id="cb2-24"><a href="training-data-preparation.html#cb2-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-25"><a href="training-data-preparation.html#cb2-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> SurveyID, DefaultBlockID</span></code></pre></div>
<p>We can then retrieve questions from our template, by specifying the <code>QuestionID</code> from the question we want to retrieve and the <code>SurveyID</code> from the template.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="training-data-preparation.html#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_question(QuestionID, SurveyID, apiToken, dataCenter):</span>
<span id="cb3-2"><a href="training-data-preparation.html#cb3-2" aria-hidden="true" tabindex="-1"></a>    baseUrl <span class="op">=</span> <span class="st">&quot;https://</span><span class="sc">{0}</span><span class="st">.qualtrics.com/API/v3/survey-definitions/</span><span class="sc">{1}</span><span class="st">/questions/</span><span class="sc">{2}</span><span class="st">&quot;</span>.<span class="bu">format</span>(</span>
<span id="cb3-3"><a href="training-data-preparation.html#cb3-3" aria-hidden="true" tabindex="-1"></a>        dataCenter, SurveyID, QuestionID)</span>
<span id="cb3-4"><a href="training-data-preparation.html#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="training-data-preparation.html#cb3-5" aria-hidden="true" tabindex="-1"></a>    headers <span class="op">=</span> {</span>
<span id="cb3-6"><a href="training-data-preparation.html#cb3-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;x-api-token&quot;</span>: apiToken,</span>
<span id="cb3-7"><a href="training-data-preparation.html#cb3-7" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-8"><a href="training-data-preparation.html#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="training-data-preparation.html#cb3-9" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> requests.get(baseUrl, headers<span class="op">=</span>headers)</span>
<span id="cb3-10"><a href="training-data-preparation.html#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="training-data-preparation.html#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> json.loads(response.text)[<span class="st">&quot;meta&quot;</span>][<span class="st">&quot;httpStatus&quot;</span>] <span class="op">!=</span> <span class="st">&#39;200 - OK&#39;</span>:</span>
<span id="cb3-12"><a href="training-data-preparation.html#cb3-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(json.loads(response.text)[<span class="st">&quot;meta&quot;</span>][<span class="st">&quot;httpStatus&quot;</span>])</span>
<span id="cb3-13"><a href="training-data-preparation.html#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="training-data-preparation.html#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> json.loads(response.text)[<span class="st">&quot;result&quot;</span>]</span></code></pre></div>
<p>The survey template contains questions that donâ€™t need to be modified, such as asking for a participantâ€™s MTurk ID. For the labelling question though, we need to update the questionâ€™s text with the tweet to be labelled. We do this the following way, with <code>tweet</code> being the tweet in string format:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="training-data-preparation.html#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> update_question(QuestionData, QuestionID, SurveyID, apiToken, dataCenter):</span>
<span id="cb4-2"><a href="training-data-preparation.html#cb4-2" aria-hidden="true" tabindex="-1"></a>    baseUrl <span class="op">=</span> <span class="st">&quot;https://</span><span class="sc">{0}</span><span class="st">.qualtrics.com/API/v3/survey-definitions/</span><span class="sc">{1}</span><span class="st">/questions/</span><span class="sc">{2}</span><span class="st">&quot;</span>.<span class="bu">format</span>(</span>
<span id="cb4-3"><a href="training-data-preparation.html#cb4-3" aria-hidden="true" tabindex="-1"></a>        dataCenter, SurveyID, QuestionID)</span>
<span id="cb4-4"><a href="training-data-preparation.html#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="training-data-preparation.html#cb4-5" aria-hidden="true" tabindex="-1"></a>    headers <span class="op">=</span> {</span>
<span id="cb4-6"><a href="training-data-preparation.html#cb4-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;accept&#39;</span>: <span class="st">&quot;application/json&quot;</span>,</span>
<span id="cb4-7"><a href="training-data-preparation.html#cb4-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;content-type&#39;</span>: <span class="st">&quot;application/json&quot;</span>,</span>
<span id="cb4-8"><a href="training-data-preparation.html#cb4-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;x-api-token&quot;</span>: apiToken,</span>
<span id="cb4-9"><a href="training-data-preparation.html#cb4-9" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-10"><a href="training-data-preparation.html#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="training-data-preparation.html#cb4-11" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> requests.put(baseUrl, json<span class="op">=</span>QuestionData, headers<span class="op">=</span>headers)</span>
<span id="cb4-12"><a href="training-data-preparation.html#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="training-data-preparation.html#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> json.loads(response.text)[<span class="st">&quot;meta&quot;</span>][<span class="st">&quot;httpStatus&quot;</span>] <span class="op">!=</span> <span class="st">&#39;200 - OK&#39;</span>:</span>
<span id="cb4-14"><a href="training-data-preparation.html#cb4-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(json.loads(response.text)[<span class="st">&quot;meta&quot;</span>][<span class="st">&quot;httpStatus&quot;</span>])</span>
<span id="cb4-15"><a href="training-data-preparation.html#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="training-data-preparation.html#cb4-16" aria-hidden="true" tabindex="-1"></a>QuestionData <span class="op">=</span> get_question(QuestionID<span class="op">=</span>QuestionID, SurveyID<span class="op">=</span>SurveyID, apiToken<span class="op">=</span>apiToken, dataCenter<span class="op">=</span>dataCenter)</span>
<span id="cb4-17"><a href="training-data-preparation.html#cb4-17" aria-hidden="true" tabindex="-1"></a>QuestionData[<span class="st">&#39;QuestionText&#39;</span>] <span class="op">=</span> tweet</span>
<span id="cb4-18"><a href="training-data-preparation.html#cb4-18" aria-hidden="true" tabindex="-1"></a>update_question(QuestionData<span class="op">=</span>QuestionData, QuestionID<span class="op">=</span>QuestionID, SurveyID<span class="op">=</span>SurveyID, apiToken<span class="op">=</span>apiToken,</span>
<span id="cb4-19"><a href="training-data-preparation.html#cb4-19" aria-hidden="true" tabindex="-1"></a>                dataCenter<span class="op">=</span>dataCenter)</span></code></pre></div>
<p>The entire code we used to create a Qualtrics survey using Python and the Qualtrics API is available at <code>src/1-training_data_preparation/qualtrics/get_training_set_to_qualtrics_API_classification.py</code>. After loading the questions and embedding the data into them, the survey is ready to be sent to crowdworkers.</p>
</div>
<div id="sharing-the-survey-on-mturk" class="section level3" number="2.2.2">
<h3><span class="header-section-number">2.2.2</span> Sharing the survey on MTurk</h3>
<p>To share the Qualtrics survey on MTurk, we use the Python package <code>boto3</code>. After collecting our access and secret access keys (respectively <code>access_key_id</code> and <code>secret_access_key</code>), we initiate the client:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="training-data-preparation.html#cb5-1" aria-hidden="true" tabindex="-1"></a>mturk <span class="op">=</span> boto3.client(<span class="st">&#39;mturk&#39;</span>,</span>
<span id="cb5-2"><a href="training-data-preparation.html#cb5-2" aria-hidden="true" tabindex="-1"></a>                     aws_access_key_id<span class="op">=</span>access_key_id,</span>
<span id="cb5-3"><a href="training-data-preparation.html#cb5-3" aria-hidden="true" tabindex="-1"></a>                     aws_secret_access_key<span class="op">=</span>secret_access_key,</span>
<span id="cb5-4"><a href="training-data-preparation.html#cb5-4" aria-hidden="true" tabindex="-1"></a>                     region_name<span class="op">=</span><span class="st">&#39;us-east-1&#39;</span>,</span>
<span id="cb5-5"><a href="training-data-preparation.html#cb5-5" aria-hidden="true" tabindex="-1"></a>                     endpoint_url<span class="op">=</span><span class="st">&#39;https://mturk-requester.us-east-1.amazonaws.com&#39;</span></span>
<span id="cb5-6"><a href="training-data-preparation.html#cb5-6" aria-hidden="true" tabindex="-1"></a>                     )</span></code></pre></div>
<p>To create an MTurk task, usually called a HIT, we need to provide an XML file containing all of the HIT information and content. We therefore prepare dictionaries containing specific content, such as HIT title or description, for each language. For instance, for the HIT title, we create this dictionary with <code>ntweets</code> being the number of tweets:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="training-data-preparation.html#cb6-1" aria-hidden="true" tabindex="-1"></a>title_dict <span class="op">=</span> {</span>
<span id="cb6-2"><a href="training-data-preparation.html#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;US&#39;</span>: <span class="st">&#39;Read </span><span class="sc">%d</span><span class="st"> English Tweets and answer a few questions&#39;</span> <span class="op">%</span> (ntweets),</span>
<span id="cb6-3"><a href="training-data-preparation.html#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;MX&#39;</span>: <span class="st">&#39;Lea </span><span class="sc">%d</span><span class="st"> Tweets en espaÃ±ol mexicano y responda algunas preguntas&#39;</span> <span class="op">%</span> (ntweets),</span>
<span id="cb6-4"><a href="training-data-preparation.html#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;BR&#39;</span>: <span class="st">&#39;Leia </span><span class="sc">%d</span><span class="st"> tweets em portuguÃªs e responda algumas perguntas&#39;</span> <span class="op">%</span> (ntweets)</span>
<span id="cb6-5"><a href="training-data-preparation.html#cb6-5" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>After preparing all of these dictionaries, we can then feed them to the <code>question_generator</code> function which will load a template previously created in HTML format (<code>template.html</code>), adapt it to the related survey and prepare the content of the related XML file in string format:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="training-data-preparation.html#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> question_generator(country_code, survey_link, instructions_dict, survey_link_text_dict, worker_input_text_dict,</span>
<span id="cb7-2"><a href="training-data-preparation.html#cb7-2" aria-hidden="true" tabindex="-1"></a>                       submit_dict):</span>
<span id="cb7-3"><a href="training-data-preparation.html#cb7-3" aria-hidden="true" tabindex="-1"></a>    xml_wrapper_begin <span class="op">=</span> <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb7-4"><a href="training-data-preparation.html#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;HTMLQuestion xmlns=&quot;http://mechanicalturk.amazonaws.com/AWSMechanicalTurkDataSchemas/2011-11-11/HTMLQuestion.xsd&quot;&gt;</span></span>
<span id="cb7-5"><a href="training-data-preparation.html#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;HTMLContent&gt;&lt;![CDATA[</span></span>
<span id="cb7-6"><a href="training-data-preparation.html#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;!-- YOUR HTML BEGINS --&gt;</span></span>
<span id="cb7-7"><a href="training-data-preparation.html#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;!DOCTYPE html&gt;</span></span>
<span id="cb7-8"><a href="training-data-preparation.html#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="st">    &quot;&quot;&quot;</span></span>
<span id="cb7-9"><a href="training-data-preparation.html#cb7-9" aria-hidden="true" tabindex="-1"></a>    xml_wrapper_end <span class="op">=</span> <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb7-10"><a href="training-data-preparation.html#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;!-- YOUR HTML ENDS --&gt;</span></span>
<span id="cb7-11"><a href="training-data-preparation.html#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="st">    ]]&gt;</span></span>
<span id="cb7-12"><a href="training-data-preparation.html#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;/HTMLContent&gt;</span></span>
<span id="cb7-13"><a href="training-data-preparation.html#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;FrameHeight&gt;0&lt;/FrameHeight&gt;</span></span>
<span id="cb7-14"><a href="training-data-preparation.html#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;/HTMLQuestion&gt;</span></span>
<span id="cb7-15"><a href="training-data-preparation.html#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="st">    &quot;&quot;&quot;</span></span>
<span id="cb7-16"><a href="training-data-preparation.html#cb7-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-17"><a href="training-data-preparation.html#cb7-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(</span>
<span id="cb7-18"><a href="training-data-preparation.html#cb7-18" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;template.html&quot;</span>,</span>
<span id="cb7-19"><a href="training-data-preparation.html#cb7-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;r&quot;</span>) <span class="im">as</span> f:</span>
<span id="cb7-20"><a href="training-data-preparation.html#cb7-20" aria-hidden="true" tabindex="-1"></a>        content <span class="op">=</span> f.read()</span>
<span id="cb7-21"><a href="training-data-preparation.html#cb7-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-22"><a href="training-data-preparation.html#cb7-22" aria-hidden="true" tabindex="-1"></a>    content <span class="op">=</span> content.replace(<span class="st">&quot;$</span><span class="sc">{INSTRUCTIONS}</span><span class="st">&quot;</span>, instructions_dict[country_code])</span>
<span id="cb7-23"><a href="training-data-preparation.html#cb7-23" aria-hidden="true" tabindex="-1"></a>    content <span class="op">=</span> content.replace(<span class="st">&quot;$</span><span class="sc">{SURVEY_LINK}</span><span class="st">&quot;</span>, survey_link)</span>
<span id="cb7-24"><a href="training-data-preparation.html#cb7-24" aria-hidden="true" tabindex="-1"></a>    content <span class="op">=</span> content.replace(<span class="st">&quot;$</span><span class="sc">{SURVEY_LINK_TEXT}</span><span class="st">&quot;</span>, survey_link_text_dict[country_code])</span>
<span id="cb7-25"><a href="training-data-preparation.html#cb7-25" aria-hidden="true" tabindex="-1"></a>    content <span class="op">=</span> content.replace(<span class="st">&quot;$</span><span class="sc">{WORKER_INPUT_TEXT}</span><span class="st">&quot;</span>, worker_input_text_dict[country_code])</span>
<span id="cb7-26"><a href="training-data-preparation.html#cb7-26" aria-hidden="true" tabindex="-1"></a>    content <span class="op">=</span> content.replace(<span class="st">&quot;$</span><span class="sc">{SUBMIT}</span><span class="st">&quot;</span>, submit_dict[country_code])</span>
<span id="cb7-27"><a href="training-data-preparation.html#cb7-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-28"><a href="training-data-preparation.html#cb7-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> xml_wrapper_begin <span class="op">+</span> content <span class="op">+</span> xml_wrapper_end</span></code></pre></div>
<p>Afterwards, when the HIT content is ready, we need to preselect the crowdworkers to make sure they live in the same country as the authors from the tweets that they will label. That way, they speak the same language but also can better understand linguistic subtleties, such as humor or specific words from the region of origin. For instance, to make sure the crowdworkers working on our HIT are based in the U.S., we create this qualification requirements list:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="training-data-preparation.html#cb8-1" aria-hidden="true" tabindex="-1"></a>QualificationRequirements_list <span class="op">=</span> [</span>
<span id="cb8-2"><a href="training-data-preparation.html#cb8-2" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb8-3"><a href="training-data-preparation.html#cb8-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;QualificationTypeId&#39;</span>: <span class="st">&#39;00000000000000000071&#39;</span>,  <span class="co"># Worker_Locale</span></span>
<span id="cb8-4"><a href="training-data-preparation.html#cb8-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;Comparator&#39;</span>: <span class="st">&#39;EqualTo&#39;</span>,</span>
<span id="cb8-5"><a href="training-data-preparation.html#cb8-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;LocaleValues&#39;</span>: [{</span>
<span id="cb8-6"><a href="training-data-preparation.html#cb8-6" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;Country&#39;</span>: <span class="st">&#39;US&#39;</span>}],</span>
<span id="cb8-7"><a href="training-data-preparation.html#cb8-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;RequiredToPreview&#39;</span>: <span class="va">True</span>,</span>
<span id="cb8-8"><a href="training-data-preparation.html#cb8-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;ActionsGuarded&#39;</span>: <span class="st">&#39;PreviewAndAccept&#39;</span></span>
<span id="cb8-9"><a href="training-data-preparation.html#cb8-9" aria-hidden="true" tabindex="-1"></a>    }]</span></code></pre></div>
<p>Finally, we can create the HIT. At this step, we can specify specific parameters, such as the maximum number of workers allowed to take the survey <code>n_workers</code> or the amount of money they get to complete the survey <code>money_for_hit</code>.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="training-data-preparation.html#cb9-1" aria-hidden="true" tabindex="-1"></a>new_hit <span class="op">=</span> mturk.create_hit(</span>
<span id="cb9-2"><a href="training-data-preparation.html#cb9-2" aria-hidden="true" tabindex="-1"></a>    MaxAssignments<span class="op">=</span>n_workers,</span>
<span id="cb9-3"><a href="training-data-preparation.html#cb9-3" aria-hidden="true" tabindex="-1"></a>    AutoApprovalDelayInSeconds<span class="op">=</span><span class="dv">172800</span>,</span>
<span id="cb9-4"><a href="training-data-preparation.html#cb9-4" aria-hidden="true" tabindex="-1"></a>    LifetimeInSeconds<span class="op">=</span><span class="dv">259200</span>,</span>
<span id="cb9-5"><a href="training-data-preparation.html#cb9-5" aria-hidden="true" tabindex="-1"></a>    AssignmentDurationInSeconds<span class="op">=</span><span class="dv">10800</span>,</span>
<span id="cb9-6"><a href="training-data-preparation.html#cb9-6" aria-hidden="true" tabindex="-1"></a>    Reward<span class="op">=</span><span class="bu">str</span>(money_for_hit),</span>
<span id="cb9-7"><a href="training-data-preparation.html#cb9-7" aria-hidden="true" tabindex="-1"></a>    Title<span class="op">=</span><span class="ss">f&#39;</span><span class="sc">{</span>title_dict[args.country_code]<span class="sc">}</span><span class="ss"> v</span><span class="sc">{</span>args<span class="sc">.</span>version_number<span class="sc">}</span><span class="ss">&#39;</span>,</span>
<span id="cb9-8"><a href="training-data-preparation.html#cb9-8" aria-hidden="true" tabindex="-1"></a>    Description<span class="op">=</span>description_dict[args.country_code],</span>
<span id="cb9-9"><a href="training-data-preparation.html#cb9-9" aria-hidden="true" tabindex="-1"></a>    Keywords<span class="op">=</span>keywords_dict[args.country_code],</span>
<span id="cb9-10"><a href="training-data-preparation.html#cb9-10" aria-hidden="true" tabindex="-1"></a>    QualificationRequirements<span class="op">=</span>QualificationRequirements_list <span class="cf">if</span> create_hits_in_production <span class="cf">else</span> <span class="bu">list</span>(),</span>
<span id="cb9-11"><a href="training-data-preparation.html#cb9-11" aria-hidden="true" tabindex="-1"></a>    Question<span class="op">=</span>question</span>
<span id="cb9-12"><a href="training-data-preparation.html#cb9-12" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>The HIT is now online and crowdworkers are able to take it. You can check the progress on qualtrics by looking at the number of replies to a given survey. When the number of replies reaches <code>n_workers</code>, the HIT is finished. The labelled data can then be extracted from Qualtrics.</p>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="index.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="finetuning-bert-based-models.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/worldbank/SDG-big-data/tree/GPS-analytics/01-training_data_preparation.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["twitter-analytics.pdf", "twitter-analytics.epub"],
"search": {
"engine": "lunr",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
